\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{sphinxcronologic}
\author{cronologic GmbH \& Co KG}

\RequirePackage{ifthen}
\RequirePackage{xstring}
\RequirePackage{xpatch} % pretend and append to cmd using xpre/apptocmd
\RequirePackage{kvoptions}
\SetupKeyvalOptions{family=crono, prefix=crono@}

% options provided with the sphinxcronologic package, e.g.
% \usepackage[font=montserrat]{sphinxcronologic}
\DeclareStringOption[montserrat]{font} % montserrat or fira or default
\ProcessKeyvalOptions{crono}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% colors
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\PassOptionsToPackage{usenames,dvipsnames}{xcolor}
\RequirePackage{xcolor}
\definecolor{org}{RGB}{237,120,0}
\definecolor{gry}{RGB}{157,157,156}
\definecolor{cronogrey}{gray}{0.5} %Variablendeklaration API
\definecolor{cronorange}{RGB}{237, 120, 0}
\definecolor{cronblue}{RGB}{55, 110, 181}
\definecolor{cronolightgreen}{RGB}{86,159,214}
\definecolor{cronblack}{RGB}{0,0,0}
\definecolor{keywordred}{RGB}{142,33,0}
% \DUrole{color} is expanded to \docutilsrolecolor
\newcommand{\docutilsrolectypered}[1]{{\color{ctypered} #1}}
\newcommand{\docutilsrolered}[1]{{\color{red} #1}}
\newcommand{\docutilsrolecronoblue}[1]{{\color{cronblue} #1}}

\RequirePackage{graphicx} %for including figures
\RequirePackage{tabularx}
\RequirePackage{ragged2e} % provide RaggedRight, RaggedLeft
\RequirePackage{tikz} % double line border support
\PassOptionsToPackage{section,subsection,subsubsection}{extraplaceins}
\RequirePackage{extraplaceins} %for binding figures to a (sub-)section
\RequirePackage{array} %for centered AND constant width columns
\RequirePackage{microtype} % better textblock layout
\RequirePackage{svg}
\RequirePackage{epstopdf}

\RequirePackage{caption}
\DeclareCaptionFont{cronocaptionlabelfont}{\bfseries\color{gry}}
\DeclareCaptionFont{cronocaptionfont}{\color{gry}}
\captionsetup{
    labelsep=space,
    labelfont=cronocaptionlabelfont,
    textfont=cronocaptionfont,
}

% \PassOptionsToPackage{footsepline=1pt}{scrlayer-scrpage}
\RequirePackage{makecell}  % multi line table cells


%%
% Font setup
%%
\RequirePackage{fontspec}
\RequirePackage{unicode-math}[mathrm=sym,math-style=ISO,bold-style=upright]
\defaultfontfeatures{Scale=MatchLowercase}

\ifthenelse{\equal{\crono@font}{montserrat}}
{
    \setmainfont[
        ItalicFont={Montserrat-Italic.otf},
        BoldFont={Montserrat-Bold.otf},
        BoldItalicFont={Montserrat-BoldItalic.otf}
    ]{Montserrat-Regular.otf}
    \setsansfont[
        ItalicFont={Montserrat-Italic.otf},
        BoldFont={Montserrat-Bold.otf},
        BoldItalicFont={Montserrat-BoldItalic.otf}
    ]{Montserrat-Regular.otf}

    \setmonofont[
        ItalicFont={AnonymousPro-Italic.ttf},
        BoldFont={AnonymousPro-Bold.ttf},
        BoldItalicFont={AnonymousPro-BoldItalic.ttf}
    ]{AnonymousPro-Regular.ttf}

    \setmathfont[Scale=MatchUppercase]{Latin Modern Math}

    \setmathfont[range=up/{latin,Latin,num}]{Montserrat-Regular.otf}
    \setmathfont[range=it/{latin,Latin,num}]{Montserrat-Italic.otf}
    \setmathfont[range=bfup/{latin,Latin,num}]{Montserrat-Bold}
    \setmathfont[range=bfit/{latin,Latin,num}]{Montserrat-BoldItalic.otf}

    \setmathfont[range=up/{greek,Greek}]{KerkisSans.otf}
    \setmathfont[range=it/{greek,Greek}]{KerkisSans-Italic.otf}
    \setmathfont[range=bfup/{greek,Greek}]{KerkisSans-Bold.otf}
    \setmathfont[range=bfit/{greek,Greek}]{KerkisSans-BoldItalic.otf}

    \newfontfamily\sectionfont[
        Numbers=OldStyle,
        ItalicFont={Montserrat-Italic.otf},
        BoldFont={Montserrat-Bold.otf},
        BoldItalicFont={Montserrat-BoldItalic.otf}
    ]{Montserrat-Regular.otf}
}{\relax}

\ifthenelse{\equal{\crono@font}{fira}}
{
    \setmainfont[
        ItalicFont={FiraSans-Italic.otf},
        BoldFont={FiraSans-Bold.otf},
        BoldItalicFont={FiraSans-BoldItalic.otf}
    ]{FiraSans-Regular.otf}
    \setsansfont[
        ItalicFont={FiraSans-Italic.otf},
        BoldFont={FiraSans-Bold.otf},
        BoldItalicFont={FiraSans-BoldItalic.otf}
    ]{FiraSans-Regular.otf}
    \setmonofont[
        ItalicFont={FiraMono-Oblique.otf},
        BoldFont={FiraMono-Bold.otf},
        BoldItalicFont={FiraMono-BoldOblique.otf}
    ]{FiraMono-Regular.otf}
    \newfontfamily\sectionfont
    [
        Numbers=OldStyle,
        ItalicFont={Montserrat-Italic.otf},
        BoldFont={Montserrat-Bold.otf},
        BoldItalicFont={Montserrat-BoldItalic.otf}
    ]
    {Montserrat-Regular.otf}

    \setmathfont{Fira Math}
}{\relax}

\ifthenelse{\equal{\crono@font}{avenirnext}}
{
    \setmainfont[
        % ItalicFont={Avenir Next Italic},
        % BoldFont={Avenir Next Demi Bold},
        % BoldItalicFont={Avenir Next Demi Bold Italic}
    ]{Avenir Next}
    \setsansfont[
        % ItalicFont={Avenir Next Italic},
        % BoldFont={Avenir Next Demi Bold},
        % BoldItalicFont={Avenir Next Demi Bold Italic}
    ]{Avenir Next}

    \setmonofont[
        ItalicFont={AnonymousPro-Italic.ttf},
        BoldFont={AnonymousPro-Bold.ttf},
        BoldItalicFont={AnonymousPro-BoldItalic.ttf}
    ]{AnonymousPro-Regular.ttf}

    \setmathfont[Scale=MatchUppercase]{Latin Modern Math}

    \setmathfont[range=up/{latin,Latin,num,greek,Greek}]{Avenir Next Regular}
    \setmathfont[range=it/{latin,Latin,num,greek,Greek}]{Avenir Next Italic}
    \setmathfont[range=bfup/{latin,Latin,num,greek,Greek}]{Avenir Next Demi Bold}
    \setmathfont[range=bfit/{latin,Latin,num,greek,Greek}]{Avenir Next Demi Bold Italic}

    \newfontfamily\headerfont{Avgardm.ttf}
}{\relax}

\ifthenelse{\equal{\crono@font}{default}}
{
    \newcommand\headerfont{}
}{\relax}


%%%%%%%%%% Definitions for the whole document 
 
\RequirePackage{pdfpages}
% make cronologic titlepage
\newcommand{\cronofront}[1]{
    \includepdf[pages={1}]{#1}
}
\newcommand{\cronoback}[1]{
    \includepdf[pages={2}]{#1}
}

\PassOptionsToPackage{
    colorlinks=true,
    linkcolor=cronblue,
    urlcolor=gry
}{hyperref}
\RequirePackage{hyperref}

% format headings
\titleformat{\chapter}%
    {\headerfont\LARGE\bfseries\color{cronorange}}%
    {\thechapter}{1em}{\thispagestyle{normal}}{}
\titlespacing*{\chapter}%
    {0ex}{0ex}{*2}

\titleformat{\section}%
    {\headerfont\Large\bfseries\color{cronorange}}%
    {\thesection}{1em}{}{}

\titleformat{\subsection}%
    {\headerfont\large\bfseries\color{cronblue}}%
    {\thesubsection}{1em}{}{}

\titleformat{\subsubsection}%
    {\bfseries\itshape\sffamily\color{cronblue}}%
    {\thesubsubsection}{1em}{}{}


%
\setlength{\headheight}{14.5pt}
\fancypagestyle{normal}{
    \fancyhf{}
    \fancyfoot[LO]{{\headerfont\color{cronogrey}cronologic GmbH \& Co. KG}}
    \fancyfoot[RO]{{\headerfont\color{cronogrey}\thepage}}
    \if@twoside
        \fancyfoot[RE]{{\headerfont\color{cronogrey}cronologic GmbH \& Co. KG}}
        \fancyfoot[LE]{{\headerfont\color{cronogrey}\thepage}}
    \fi
    \fancyhead[R]{{\headerfont\color{cronogrey}\@title\sphinxheadercomma\py@release}}
    \renewcommand{\headrulewidth}{0.4pt}
    \renewcommand{\footrulewidth}{0.4pt}
    \xpretocmd\headrule{\begingroup\color{cronogrey}}{}{\PatchFailed}
    \xapptocmd\headrule{\endgroup}{}{\PatchFailed}
    \xpretocmd\footrule{\begingroup\color{cronogrey}}{}{\PatchFailed}
    \xapptocmd\footrule{\endgroup}{}{\PatchFailed}
}